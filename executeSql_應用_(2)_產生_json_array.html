<!DOCTYPE html><html lang='en'>  <head>    <meta charset='UTF-8' />    <meta aceVersion='v1.4.14' frameVersion='v1' />    <meta http-equiv='X-UA-Compatible' content='IE=edge' />    <meta name='viewport' content='width=device-width, initial-scale=1.0' />    <title>executeSql 應用 (2) 產生 json array</title>    <style>:root {  font-family: 'times new roman', helvetica, 'songti TC', monaco, 'SF Pro';  font-size: 16px;  background-color: #111;  margin: 0;  padding: 0;  color: #eee;  hyphens: auto;--background_th: #333;}#main-subject {  font-size: 1.2rem;  background-color: rgba(45, 45, 45, 0.6);  color: white;  /* display:inline-block; */  position: fixed;  left: 6px;  top: 6px;  padding: 6px 3px;  align-content: flex-start;  text-decoration: none;  width: 97%;  margin: 0;  box-shadow: 2px 2px 6px 2px rgba(0, 0, 0, 0.7);  box-sizing: border-box;  border-radius: 3px;}/* btn toEdit, tsToTc */#btn-toEdit, #btn-tsToTc {  font-size: 1.2rem;  background-color: rgba(45, 45, 45, 0.6);  color: white;  margin: 0;  box-shadow: 2px 2px 6px 2px rgba(0, 0, 0, 0.7);  box-sizing: border-box;  border-radius: 16px;  cursor:pointer;  align-content: flex-start;}/* btn toEdit */#btn-toEdit {  right: 6px;  top: 6px;  padding: 6px 3px;  text-align: center; /* 文字居中 */  width: 32px;  position: fixed;}/* btn tsToTc */#btn-tsToTc {  right: 44px;  top: 6px;  padding: 6px 3px;  text-align: center; /* 文字居中 */  width: 64px;  position: fixed;}#main-subject:hover,#btn-toEdit:hover,#btn-tsToTc:hover {  background-color: rgba(45, 45, 45, 0.9);  color: #c0edfe;}#main-subject:active,#btn-toEdit:active,#btn-tsToTc:active {  background-color: rgb(255, 145, 45);  color: #c0edfe;}.subNote {  right:20px;  text-align: right;  font-size: 0.9rem;  color: lightGray;}content {  color: lightgray;}p {  color: #ddd;  font-size: 1rem;  height: auto;  padding: 0rem;  margin-block-start: 0.5rem;  margin-block-end: 0.5rem;}hr {  color: #666;  height: 0.5px;}a {  border: none;  color: #ff5;  height: 100%;  text-decoration: none;}a:hover {  color: #fa3;}a:hover:after {  left: auto;  right: 0;  width: 100%;}a:active {  top: 2px;}/* table 样式 */table {  border-top: 1px solid #ccc;  border-left: 1px solid #ccc;}table td,table th {  border-bottom: 1px solid #ccc;  border-right: 1px solid #ccc;  padding: 3px 5px;}table th { background-color: var(--background_th) !important;  border-bottom: 2px solid #ccc;  text-align: center;}/* blockquote 样式 */blockquote {  display: block;  border-left: 5px solid #d0e5f2;  padding: 3px 5px;  margin: 6px 0;  line-height: 1.4;  font-size: 100%;  background-color: #f1f1f1;}/* code 样式 */code {  display: inline-block;  *display: inline;  *zoom: 1;  color: lightgray;  background-color: #fff3;  border-radius: 1px;  padding: 1px 3px;  margin: 0 1px;  font-size: 0.9rem;  font-family: monaco 'robot mono' mono !important;}pre code {  display: block;}/* ul ol 样式 */ul,ol {  margin-left: 8px;  padding-left:4px;  padding-right: 0;}li{  margin-left:0;  padding-left:0px;}ul li{  list-style-type: disc;}ol lit{  list-style-type: decimal;}.sectionTitle {  font-size: 1.2rem;}.preCodecontianer {  background-color: #fff1;}.cssDefault {  font-size: 0.9rem;  color: gray;  margin-left: 1rem;}footer {  text-align: right;  padding: 1px 12px;  margin:1px;  background-color: #8882;  color: lightgray;  bottom:8px;  right:24px;  position:fixed;  z-index: 1;}h1{  font-size:24px;}h2{  font-size:22px;}h3{  font-size:20px;}h4{  font-size:18px;}h5{  font-size:16px;}font[size='1']{  font-size:12px;  padding: 0.1em;  margin: 0.1em;}font[size='2']{  font-size:14px;  padding: 0.1em;  margin: 0.1em;}font[size='3']{  font-size:16px;  padding: 0.1em;  margin: 0.1em;}font[size='4']{  font-size:18px;  padding: 0.1em;  margin: 0.1em;}font[size='5']{  font-size:20px;  padding: 0.1em;  margin: 0.1em;}font[size='6']{  font-size:22px;  padding: 0.1em;  margin: 0.1em;}font[size='7']{  font-size:24px;  padding: 0.2em;}blockquote, blockquote p{  background:#0003 !important;}blockquote, blockquote p{  background:transparent !important;}/* width */::-webkit-scrollbar {width: 12px;}/* Track */::-webkit-scrollbar-track {background: #333;}/* Handle */::-webkit-scrollbar-thumb {background: #345;}/* Handle on hover */::-webkit-scrollbar-thumb:hover {background: #357;}</style>    <style>:root {  margin: 0;  padding: 0;  font-family: 'times new roman', helvetica, 'songti TC', monaco, 'SF Pro';  --background: #111;  --color: #ddd;  --font-size: 16px;  --background_th: #555;  --color-a: #ff5;  --color-a-hover: #fa3;  --background-blockquote: #00e9;  --font-size-code: 14px;  --background-code: #fff3;  background-color: var(--background);  color: var(--color);  font-size: var(--font-size);}.notesView{  background-color: #0308;  margin:0;  padding:8px 2px 8px 16px;}.codeView{  background-color: #0038;  margin:0;  padding:8px 2px 8px 16px;}.resultView{  background-color: #3008;  margin:0;  padding:8px 2px 8px 16px;}.code, .result{  font-family: monaco, monospace;  font-size:13px;  color:var(--color);}</style>  </head>  <body>    <!--完整檢視才顯示, begin-->    <div class='notesView'>      <p id='main-subject'>executeSql 應用 (2) 產生 json array</p>      <br><br><div class='content'><p>必須確認取得資料中不含控制字元, 例如 ¶, tab, 雙引號, line feed,…</p><p>如果有特殊的字元, 則需要做 escape 處理</p><p><a target="_blank" href="https://docs.microsoft.com/zh-tw/sql/relational-databases/json/how-for-json-escapes-special-characters-and-control-characters-sql-server?view=sql-server-ver16">FOR JSON 如何逸出特殊字元和控制字元 (SQL Server)</a></p><p>直接用文字函數產生 json array 的速度比用 while 和 jsonSetelement 速度快很多</p><p>直接用文字函數產生 json array 的 json element 都是用 jsonString 的 type<br/></p><p>可以使用 jsonFormatElement 檢查 json 內容是否是合格的 json</p></div>    </div>    <div class='codeView'><p class='codeViewTitle'>計算式:</p><pre class='code'>/*必須確認取得資料中不含控制字元, 例如 ¶, tab, 雙引號, line feed,...*/let (   [     ~cSep = "\",\"" ;    ~rSep = "\"],[\"" ;    ~lead = "[[\"" ;    ~tail = "\"]]";    // 進行計算    ~content = executeSql("      Select name, addrCity || addrStr, telAreaCode ||'-'|| telNo       From company       Where addrCity = '桃園市' And stroke &gt; 18 " ; ~cSep ; ~rSep);    ~content = ~lead & ~content & ~tail  ];  jsonformatElements (~content))</pre></div><div class='resultView'><p class='resultViewTitle'>計算結果:</p><pre class='result'>[	[		"饑口容曲生物科技有限公司",		"桃園市蘆竹區南順六街96號5樓",		"03-268-2241"	],	[		"辭銀母宮企業有限公司",		"桃園市龜山區文化七路251號12樓",		"03-267-9068"	],	[		"曦口商業股份有限公司",		"桃園市觀音區經建一路228號3樓",		"03-252-3769"	],	[		"顰虞寫木業有限公司",		"桃園市新屋區新生五街179號8樓",		"03-262-8777"	],	[		"靡荷實業股份有限公司",		"桃園市蘆竹區山林路３段245號1樓",		"03-269-2365"	],	[		"勸芥國際股份有限公司",		"桃園市新屋區圳禾路52號3樓",		"03-262-7336"	],	[		"蘭助曠實業股份有限公司",		"桃園市復興區下宇內8號2樓",		"03-259-3096"	]]</pre></div><div class='codeView'><p class='codeViewTitle'>計算式:</p><pre class='code'>/*必須確認取得資料中不包含控制字元, 例如 ¶, tab, 雙引號, line feed,...取得 1000 多筆資料花不到 0.1 秒, 不要再用 loop 一筆一筆的取資料了fieldNames array 的順序和 records array 的順序是對應的所產生的內容可以用來複製關聯表的內容這個方法可以應用在複製訂單, 出貨單, 報價單...*/let (   [     /* 指定要取得資料的欄位 */    ~fNList = list (       getFieldName (contact::name );      getFieldName (contact::nameEng );      getFieldName (contact::addrCity );      getFieldName (contact::addrStr ));    /* 產生 fieldNames array, begin */    /* fully qualified field name json array, 在複製資料可以直接應用 script step: set field by name */    ~fN_json = "('" & Substitute ( ~fNList ; ¶ ; "','" ) & "')" ;    ~fN_json = substitute ( ~fN_json ; [ "(" ; "[" ];[ ")" ; "]" ]; ["'" ; "\""] );    ~json = jsonSetElement ( "{}" ; "fieldNames" ; ~fN_json ; 4 );    /* 產生 fieldNames array, end */    /* 產生 records array, begin */    ~fnString = substitute ( ~fNList ; [ "::" ; "." ];[ ¶ ; ", " ] );    ~cSep = "\",\"" ;    ~rSep = "\"],[\"" ;    ~lead = "[[\"" ;    ~trail = "\"]]";    ~sql = executeSql("      Select " & ~fnString & "       From contact       Where addrCity = ? And stroke &gt; ?      Order By RowId      Fetch First 30 Rows Only      " ; ~cSep ; ~rSep ; "台中市" ; 12 );    ~content = ~lead & ~sql & ~trail ;    /* 產生 records array, end */    ~json= jsonSetElement ( ~json ; "records" ; ~content ; 4 )  ];	// jsonformatElements 用來檢查 json 是否成立	if ( left ( jsonformatElements (~json) ; 1 ) = "?" ; jsonformatElements (~json) ; ~json ))</pre></div><div class='resultView'><p class='resultViewTitle'>計算結果:</p><pre class='result'>{"fieldNames":["contact::name","contact::nameEng","contact::addrCity","contact::addrStr"],"records":[["薛雞疲","Marian","台中市","大安區福安路177號3樓"],["謝孰府","Trista","台中市","大安區溪洲路136號9樓"],["錢發","Owen","台中市","沙鹿區北英路57號1樓"],["謝獲詳","Sabina","台中市","清水區新興路長壽巷78號4樓"],["謝聚游","Reg","台中市","北區漢口南二街99號11樓"],["葉軍桐","Gale","台中市","梧棲區興農路136號5樓"],["詹荷","Olive","台中市","霧峰區復興八街187號4樓"],["溫照升","Chapman","台中市","大肚區福興街140號7樓"],["溫蓋","Francis","台中市","西屯區永福路11號11樓"],["董京","Ronald","台中市","后里區重劃東路10號6樓"],["溫霸懷","Maximilian","台中市","沙鹿區太平路75號9樓"],["詹造","Sophia","台中市","北屯區陳平一街117號1樓"],["董竹并","Harley","台中市","大安區松三街132號2樓"],["溫誅","Lindsay","台中市","和平區和平路２段201號12樓"],["詹魏內","Aubrey","台中市","南屯區溫泉路110號5樓"],["鄒釋驅","Gabriel","台中市","大甲區和平路135號6樓"],["鄒誠語","Xavier","台中市","清水區南新路254號7樓"],["溫聚","Marvin","台中市","大雅區大林路65號3樓"],["詹金","Samantha","台中市","外埔區土城路1號5樓"],["董微壁","Nick","台中市","后里區二圳路165號2樓"],["鄒索書","Gemma","台中市","清水區民享五街61號6樓"],["溫收晚","Nicole","台中市","梧棲區南堤路３段70號9樓"],["葉樂本","Cecilia","台中市","大安區東西二路53號1樓"],["溫天","Ina","台中市","石岡區豐勢路岡尾巷175號7樓"],["溫此賢","Sheila","台中市","大甲區日南路22號12樓"],["詹給起","Malcolm","台中市","沙鹿區成功西街121號5樓"],["葉適莫","Dora","台中市","潭子區大德南路140號11樓"],["詹覆芥","Norton","台中市","外埔區六分路167號5樓"],["董理暉","Valentine","台中市","石岡區石城街崁下巷28號3樓"],["楊合","Monica","台中市","清水區港新二路62號6樓"]]}</pre></div>    <footer><p>update: 2022/06/27 17:54:21 by: Jeff</p><a class='repo' href='https://github.com/JSLiao/FileMaker-executeSql' target='_blank'>repository</a></footer>    <script></script>  </body></html>